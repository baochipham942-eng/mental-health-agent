generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model User {
  id              String             @id @default(cuid())
  username        String             @unique
  passwordHash    String
  nickname        String?
  createdAt       DateTime           @default(now())
  avatar          String?
  phone           String?            @unique
  quickLoginToken String?
  reports         AssessmentReport[]
  conversations   Conversation[]
  exerciseLogs    ExerciseLog[]
  memories        UserMemory[]
  sessionSummaries SessionSummary[]
  evaluations     ConversationEvaluation[]
}

model InvitationCode {
  id        String   @id @default(cuid())
  code      String   @unique
  type      String   @default("REGISTRATION")
  maxUsages Int      @default(1)
  usedCount Int      @default(0)
  expiresAt DateTime
  channel   String?
  createdAt DateTime @default(now())
}

model Conversation {
  id        String                  @id @default(cuid())
  userId    String
  title     String?
  status    String                  @default("ACTIVE")
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt
  isHidden  Boolean                 @default(false)
  user      User                    @relation(fields: [userId], references: [id])
  messages  Message[]
  summary   SessionSummary?
  evaluation ConversationEvaluation?
}

model Message {
  id             String           @id @default(cuid())
  conversationId String
  role           String
  content        String
  meta           Json?
  createdAt      DateTime         @default(now())
  conversation   Conversation     @relation(fields: [conversationId], references: [id])
  feedback       MessageFeedback?
}

model MessageFeedback {
  id        String   @id @default(cuid())
  messageId String   @unique
  userId    String
  rating    Int
  reason    String?
  comment   String?
  createdAt DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id])

  @@index([userId])
  @@index([rating])
}

model AssessmentReport {
  id             String       @id @default(cuid())
  userId         String
  conversationId String
  summary        String
  riskLevel      String
  mainIssue      String?
  createdAt      DateTime     @default(now())
  actionPlans    ActionPlan[]
  user           User         @relation(fields: [userId], references: [id])
}

model ActionPlan {
  id          String           @id @default(cuid())
  reportId    String
  title       String
  type        String
  content     Json
  isCompleted Boolean          @default(false)
  report      AssessmentReport @relation(fields: [reportId], references: [id])
  logs        ExerciseLog[]
}

model ExerciseLog {
  id           String      @id @default(cuid())
  userId       String
  actionPlanId String?
  type         String
  duration     Int
  preMood      Int?
  postMood     Int?
  feedback     String?
  completedAt  DateTime    @default(now())
  actionPlan   ActionPlan? @relation(fields: [actionPlanId], references: [id])
  user         User        @relation(fields: [userId], references: [id])
}

model UserMemory {
  id              String   @id @default(cuid())
  userId          String
  topic           String
  content         String
  confidence      Float    @default(0.8)
  sourceConvId    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  accessedAt      DateTime @default(now())
  entities        Json?
  relationships   Json?
  // Ebbinghaus forgetting curve fields
  accessCount     Int      @default(1)    // Number of times this memory was accessed
  stabilityFactor Float    @default(1.0)  // Memory stability (increases with each access)
  memoryStrength  Float    @default(1.0)  // Current memory strength (0-1, decays over time)
  user            User     @relation(fields: [userId], references: [id])

  @@index([userId, topic])
  @@index([userId, updatedAt])
}

model MemoryExtractionLog {
  id             String   @id @default(cuid())
  conversationId String
  extractedCount Int
  status         String
  error          String?
  createdAt      DateTime @default(now())
}

model SessionSummary {
  id             String       @id @default(cuid())
  conversationId String       @unique
  userId         String
  
  // 基础信息
  mainTopic      String       // 主要议题
  startTime      DateTime     // 会话开始时间
  endTime        DateTime     // 会话结束时间
  duration       Int          // 持续时间（分钟）
  
  // 情绪变化
  emotionInitial Json         // { label: "焦虑", score: 7 }
  emotionFinal   Json         // { label: "轻松", score: 4 }
  moodChange     Int?         // 情绪变化值 (Final Score - Initial Score)
  
  // 核心内容
  keyInsights    Json         // ["洞察1", "洞察2"]
  actionItems    Json         // ["行动1", "行动2"]
  keyTopics      Json         // ["工作压力", "焦虑"]
  
  // 专业观察
  therapistNote  String       // 咨询师观察
  
  createdAt      DateTime     @default(now())
  
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([createdAt])
}

model ConversationEvaluation {
  id             String   @id @default(cuid())
  conversationId String   @unique
  userId         String
  
  // 评估分数（0-10）
  legalScore        Int    // 法律合规性
  ethicalScore      Int    // 伦理规范
  professionalScore Int    // 专业性
  uxScore           Int    // 用户体验
  
  // 发现的问题（JSON 数组）
  legalIssues        Json   // string[]
  ethicalIssues      Json   // string[]
  professionalIssues Json   // string[]
  uxIssues           Json   // string[]
  
  // 整体评级
  overallGrade   String   // "A" | "B" | "C" | "D" | "F"
  overallScore   Float    // 综合得分（0-10）
  
  // 改进建议
  improvements   Json     // string[]
  
  // 元数据
  evaluatedBy    String   @default("deepseek")
  evaluatedAt    DateTime @default(now())
  
  // 审核状态: PENDING, ADOPTED, REJECTED
  reviewStatus   String   @default("PENDING")
  reviewedAt     DateTime?
  reviewedBy     String?
  reviewNote     String?  // 驳回原因
  
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([overallGrade])
  @@index([evaluatedAt])
  @@index([overallScore])
}

model PromptOptimizationLog {
  id              String    @id @default(cuid())
  
  // 分析结果
  analyzedPeriod  String    // "2025-12-15 to 2025-12-22"
  lowScoreCount   Int
  commonIssues    Json
  suggestions     Json      // string[]
  affectedPrompts Json      // string[]
  
  // 元数据
  createdAt       DateTime  @default(now())
  appliedAt       DateTime?
  appliedBy       String?
  
  @@index([createdAt])
}

model OptimizationEvent {
  id             String   @id @default(cuid())
  conversationId String
  type           String   // 'LOW_SCORE', 'NEGATIVE_FEEDBACK', 'STUCK_LOOP'
  subType        String?  // For STUCK_LOOP: 'REPETITION', 'REFUSAL', 'PHASE_TIMEOUT'
  
  // 核心快照数据（避免联表查询）
  triggerMessageId String? // 触发事件的消息ID
  severity       Int      // 严重程度 (1-10)
  summary        String   // 事件摘要 (e.g. "用户点踩：觉得太啰嗦")
  details        Json?    // 额外详情（如分数、关键词等）
  
  // 状态流转
  status         String   @default("PENDING") // 'PENDING', 'PROCESSED', 'IGNORED'
  resolution     String?  // 解决变动 (e.g. "Updated prompt v2")
  processedAt    DateTime?
  processedBy    String?
  
  createdAt      DateTime @default(now())
  
  @@index([type, status])
  @@index([conversationId])
  @@index([createdAt])
}

model GoldenExample {
  id              String   @id @default(cuid())
  
  // 来源关联
  conversationId  String
  messageId       String   @unique  // 确保同一消息不会被多次纳入
  feedbackId      String?  // 关联的用户反馈ID
  
  // 对话内容快照（避免联表查询）
  userMessage     String   // 用户的问题/输入
  assistantMessage String  // AI 的优质回复
  context         String?  // 可选的上下文摘要
  
  // 状态
  status          String   @default("ACTIVE") // 'ACTIVE', 'ARCHIVED'
  
  // 元数据
  approvedBy      String   // 审批人 ID
  approvedAt      DateTime @default(now())
  userReason      String?  // 用户点赞原因
  adminNote       String?  // 管理员备注
  
  // 使用统计
  usageCount      Int      @default(0)  // 被注入的次数
  lastUsedAt      DateTime?
  
  @@index([status])
  @@index([approvedAt])
}
