# CI æ£€æŸ¥ä¸é…ç½®å¯¹é½

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨ Cursor ç¯å¢ƒ / æœ¬åœ°å¯¹é½ smoke é…ç½®ä¸é˜ˆå€¼ï¼Œç¡®ä¿æµ‹è¯•ç»“æœçš„å¯é‡å¤æ€§ã€‚

## ç›¸å…³æ–‡æ¡£

- ğŸ“„ [æ¶æ„æ€»è§ˆ](../architecture/OVERVIEW.md) - **å•é¡µæ¶æ„æ€»è§ˆ**ï¼Œæ¶µç›–è¯·æ±‚é“¾è·¯ã€Skill ç³»ç»Ÿã€Contract/Gateã€é…ç½®ä¸ CI å¯è¿½æº¯æ€§
- ğŸ“„ [è¯¦ç»†æ¶æ„æ–‡æ¡£](../architecture/current-architecture.md) - å®Œæ•´çš„äº§å“æ¶æ„è¯´æ˜ï¼ŒåŒ…å«äº§å“èƒ½åŠ›æ€»è§ˆã€æ ¸å¿ƒæ¨¡å—æ¶æ„ã€å…³é”®ç›®å½•ä¸æ–‡ä»¶èŒè´£ç­‰

## CI é»˜è®¤æ¨¡å¼

`npm run ci:check` **é»˜è®¤å›ºå®š**ä½¿ç”¨ `SKILL_MODE=steps_and_cards` æ¨¡å¼è¿è¡Œå®Œæ•´é“¾è·¯ã€‚

**åŸå› **ï¼š
- ä¿è¯ç»“è®ºè¾“å‡º"å•ä¸€æ•°æ®æº"æ¥è‡ª Skill ç³»ç»Ÿï¼Œé¿å… LLM è¾“å‡ºå¹²æ‰°ä¸€è‡´æ€§éªŒæ”¶
- ä¿è¯ `nextStepsLines` å’Œ `actionCards` ç”± Skill ç³»ç»Ÿå•ä¸€æ•°æ®æºæ¸²æŸ“
- éªŒè¯ LLM è¾“å‡ºå‰¥ç¦»é€»è¾‘ï¼ˆç¡®ä¿ LLM ä¸ç”Ÿæˆè¿™äº›å†…å®¹ï¼‰
- éªŒè¯ gate/contract ä¸€è‡´æ€§ï¼ˆç¡®ä¿æ‰€æœ‰éªŒè¯ä½¿ç”¨åŒä¸€å¥—é€»è¾‘ï¼‰
- æå‡è¾“å‡ºä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§

åœ¨ CI ç¯å¢ƒä¸­ï¼Œ`ci:check` é€šè¿‡ `cross-env` åœ¨æ¯ä¸ªæ­¥éª¤ä¸­è‡ªåŠ¨è®¾ç½® `SKILL_MODE=steps_and_cards`ï¼Œç¡®ä¿è·¨å¹³å°ï¼ˆWindows/Mac/Linuxï¼‰è¡Œä¸ºä¸€è‡´ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ã€‚

## é…ç½®æ ¡éªŒ

### åŸºæœ¬ä½¿ç”¨

è¿è¡Œé…ç½®æ ¡éªŒè„šæœ¬ï¼ˆé»˜è®¤ warn æ¨¡å¼ï¼‰ï¼š

```bash
npm run verify:config
```

### ä¸¥æ ¼æ¨¡å¼

åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œä»»ä½•é…ç½®å·®å¼‚éƒ½ä¼šå¯¼è‡´è„šæœ¬é€€å‡ºå¹¶è¿”å›é”™è¯¯ç ï¼š

```bash
SMOKE_STRICT_CONFIG=1 npm run verify:config
```

### æœŸæœ›é…ç½®æ–‡ä»¶

å¯ä»¥åˆ›å»º `smoke.config.json` æ–‡ä»¶æ¥å®šä¹‰æœŸæœ›çš„é…ç½®å€¼ï¼š

```json
{
  "nodeVersion": "v20.11.0",
  "npmVersion": "9.8.1",
  "model": "deepseek-chat",
  "apiUrl": "https://api.deepseek.com/v1/chat/completions",
  "conclusionTemperature": 0.3,
  "conclusionMaxTokens": 300,
  "smokeConclusionP50Ms": 9500,
  "envVars": {
    "SKILL_MODE": "steps_and_cards",
    "GATE_FIX": "enabled (default)",
    "DEBUG_PROMPTS": "[æœªè®¾ç½®]"
  }
}
```

æˆ–è€…é€šè¿‡ç¯å¢ƒå˜é‡æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ï¼š

```bash
SMOKE_EXPECTED_CONFIG_JSON=./my-config.json npm run verify:config
```

### æ ¡éªŒé¡¹

é…ç½®æ ¡éªŒè„šæœ¬ä¼šæ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

1. **Node/npm ç‰ˆæœ¬**
   - Node.js >= 18.0.0
   - npm >= 9.0.0
   - å¦‚æœæä¾›äº†æœŸæœ›é…ç½®ï¼Œä¼šæ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å®Œå…¨åŒ¹é…

2. **Git çŠ¶æ€**
   - æ£€æŸ¥å·¥ä½œåŒºæ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹ï¼ˆè­¦å‘Šï¼‰

3. **LLM é…ç½®**
   - API Key æ˜¯å¦è®¾ç½®ï¼ˆé”™è¯¯ï¼‰
   - Modelã€API URLã€Temperatureã€Max Tokens æ˜¯å¦åŒ¹é…æœŸæœ›å€¼ï¼ˆè­¦å‘Šï¼‰

4. **ç¯å¢ƒå˜é‡**
   - `SKILL_MODE`
   - `GATE_FIX`
   - `DEBUG_PROMPTS`
   - `CONCLUSION_INCLUDE_HISTORY`
   - `SMOKE_CONCLUSION_P50_MS`

## CI æ£€æŸ¥å‘½ä»¤

è¿è¡Œå®Œæ•´çš„ CI æ£€æŸ¥æµç¨‹ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰ï¼š

```bash
npm run ci:check
```

è¯¥å‘½ä»¤ä¼šä¾æ¬¡æ‰§è¡Œï¼š

1. `npm run verify:config` - é…ç½®æ ¡éªŒï¼ˆé»˜è®¤ warn æ¨¡å¼ï¼‰
2. `npm run typecheck` - TypeScript ç±»å‹æ£€æŸ¥
3. `npm run validate:skills` - Skill å®šä¹‰éªŒè¯
4. `npm run test:question:policy` - Question Policy å›å½’ç”¨ä¾‹
5. `npm run test:contract` - Contract å›å½’ç”¨ä¾‹
6. `npm run test:contract:edge` - Contract è¾¹ç•Œç”¨ä¾‹æµ‹è¯•
7. `npm run test:strip` - Conclusion è¾“å‡ºå‰¥ç¦»å›å½’ç”¨ä¾‹
8. `npm run smoke` - å†’çƒŸæµ‹è¯•

ä»»ä¸€æ­¥éª¤å¤±è´¥ï¼Œæ•´ä¸ªæµç¨‹ä¼šç»ˆæ­¢ã€‚

### é»˜è®¤ warn æ¨¡å¼çš„ä½œç”¨

`verify:config` é»˜è®¤ä½¿ç”¨ warn æ¨¡å¼ï¼Œè¿™æ„å‘³ç€ï¼š
- **è­¦å‘Š**ï¼šå‘ç°é…ç½®å·®å¼‚æ—¶ï¼Œåªè¾“å‡ºè­¦å‘Šä¿¡æ¯ï¼Œä¸ä¼šä¸­æ–­æµç¨‹
- **é”™è¯¯**ï¼šåªæœ‰ä¸¥é‡é”™è¯¯ï¼ˆå¦‚ API Key æœªè®¾ç½®ï¼‰æ‰ä¼šä¸­æ–­æµç¨‹

è¿™æ ·è®¾è®¡çš„å¥½å¤„ï¼š
- åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œå…è®¸é…ç½®å·®å¼‚ï¼Œæ–¹ä¾¿è°ƒè¯•
- åœ¨ CI ç¯å¢ƒä¸­ï¼Œå¯ä»¥é€šè¿‡ `SMOKE_STRICT_CONFIG=1` å¼€å¯ä¸¥æ ¼æ¨¡å¼

### Strict æ¨¡å¼å¦‚ä½•å¼€å¯

åœ¨ CI ç¯å¢ƒä¸­ï¼Œå»ºè®®ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼ç¡®ä¿é…ç½®ä¸€è‡´æ€§ï¼š

```bash
# æ–¹å¼1ï¼šé€šè¿‡ç¯å¢ƒå˜é‡
SMOKE_STRICT_CONFIG=1 npm run ci:check

# æ–¹å¼2ï¼šåœ¨ CI é…ç½®æ–‡ä»¶ä¸­è®¾ç½®
# GitHub Actions ç¤ºä¾‹
env:
  SMOKE_STRICT_CONFIG: "1"
```

åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼š
- ä»»ä½•é…ç½®å·®å¼‚ï¼ˆåŒ…æ‹¬è­¦å‘Šï¼‰éƒ½ä¼šå¯¼è‡´è„šæœ¬é€€å‡ºå¹¶è¿”å›é”™è¯¯ç 
- ç¡®ä¿ CI ç¯å¢ƒä¸æœŸæœ›é…ç½®å®Œå…¨ä¸€è‡´

### smoke.config.json æ¨èå†™æ³•

åˆ›å»º `smoke.config.json` æ–‡ä»¶æ¥å®šä¹‰æœŸæœ›çš„é…ç½®å€¼ï¼š

```json
{
  "nodeVersion": "v20.11.0",
  "npmVersion": "9.8.1",
  "model": "deepseek-chat",
  "apiUrl": "https://api.deepseek.com/v1/chat/completions",
  "conclusionTemperature": 0.3,
  "conclusionMaxTokens": 300,
  "smokeConclusionP50Ms": 9500,
  "envVars": {
    "SKILL_MODE": "steps_and_cards",
    "GATE_FIX": "enabled (default)",
    "DEBUG_PROMPTS": "[æœªè®¾ç½®]",
    "CONCLUSION_INCLUDE_HISTORY": "[æœªè®¾ç½®]"
  }
}
```

### SMOKE_EXPECTED_CONFIG_JSON ä½¿ç”¨

å¦‚æœä¸æƒ³ä½¿ç”¨é»˜è®¤çš„ `smoke.config.json` æ–‡ä»¶åï¼Œå¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æŒ‡å®šï¼š

```bash
SMOKE_EXPECTED_CONFIG_JSON=./ci-config.json npm run verify:config
```

è¿™åœ¨ä»¥ä¸‹åœºæ™¯å¾ˆæœ‰ç”¨ï¼š
- ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„é…ç½®æ–‡ä»¶
- CI ç¯å¢ƒä½¿ç”¨ä¸“é—¨çš„é…ç½®æ–‡ä»¶
- ä¸´æ—¶ä½¿ç”¨ç‰¹å®šé…ç½®è¿›è¡Œæµ‹è¯•

## å¿…é¡»çš„ Secret é…ç½®

### DEEPSEEK_API_KEY

**å¿…é¡»è®¾ç½®**ï¼Œç”¨äºè°ƒç”¨ DeepSeek APIã€‚

#### æœ¬åœ°ç¯å¢ƒè®¾ç½®

1. åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env.local` æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
2. æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```bash
DEEPSEEK_API_KEY=your_api_key_here
```

3. å¦‚æœå¼€å‘æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œéœ€è¦é‡å¯æ‰èƒ½ç”Ÿæ•ˆ

#### CI ç¯å¢ƒè®¾ç½®

**GitHub Actions**:
1. è¿›å…¥ä»“åº“ Settings > Secrets and variables > Actions
2. ç‚¹å‡» "New repository secret"
3. Name: `DEEPSEEK_API_KEY`
4. Secret: ä½ çš„ API Key
5. ç‚¹å‡» "Add secret"

**Vercel**:
1. è¿›å…¥é¡¹ç›® Settings > Environment Variables
2. æ·»åŠ å˜é‡ï¼š
   - Key: `DEEPSEEK_API_KEY`
   - Value: ä½ çš„ API Key
   - Environment: Production, Preview, Developmentï¼ˆæ ¹æ®éœ€è¦é€‰æ‹©ï¼‰
3. ç‚¹å‡» "Save"

**å…¶ä»– CI ç³»ç»Ÿ**:
åœ¨ CI ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡/Secret é…ç½®ä¸­æ·»åŠ  `DEEPSEEK_API_KEY`

## æœ¬åœ°è·‘é€š ci:check çš„æœ€å°æ­¥éª¤ï¼ˆä¸æ”¹ä»£ç ç‰ˆï¼‰

**é‡è¦è¯´æ˜**ï¼šä»£ç æ”¹åŠ¨å·²åŒ…å«åœ¨ä»“åº“ä¸­ï¼Œæœ¬åœ°ä¸éœ€è¦å†æ‰‹æ”¹ä»»ä½• TS/JS æ–‡ä»¶ï¼Œåªéœ€åŒæ­¥ä»£ç +è£…ä¾èµ–+è¡¥ç¯å¢ƒå˜é‡å³å¯ã€‚

### å®Œæ•´æ­¥éª¤

1. **åŒæ­¥ä»£ç **
   ```bash
   git pull
   ```

2. **å®‰è£…ä¾èµ–**
   ```bash
   npm i
   ```

3. **åˆ›å»º/æ›´æ–° .env.local**
   
   åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºæˆ–æ›´æ–° `.env.local` æ–‡ä»¶ï¼Œè‡³å°‘åŒ…å«ï¼š
   ```bash
   DEEPSEEK_API_KEY=your_api_key_here
   ```
   
   **æ³¨æ„**ï¼šå¦‚æœ `npm run dev` æ­£åœ¨è¿è¡Œï¼Œéœ€è¦é‡å¯å¼€å‘æœåŠ¡å™¨æ‰èƒ½è®©ç¯å¢ƒå˜é‡ç”Ÿæ•ˆã€‚

4. **è¿è¡Œ CI æ£€æŸ¥**
   ```bash
   npm run ci:check
   ```

### é¢„æœŸç°è±¡

- **å¦‚æœ DEEPSEEK_API_KEY å·²è®¾ç½®**ï¼š
  - `verify:config` ä¼šæ˜¾ç¤º `DEEPSEEK_API_KEY: [å·²è®¾ç½®]`
  - æ‰€æœ‰æ£€æŸ¥æ­¥éª¤ä¼šä¾æ¬¡æ‰§è¡Œå¹¶é€šè¿‡

- **å¦‚æœ DEEPSEEK_API_KEY æœªè®¾ç½®**ï¼š
  - `verify:config` ä¼šæ˜¾ç¤º `DEEPSEEK_API_KEY: [æœªè®¾ç½®]`
  - ä¼šè¾“å‡ºè¯¦ç»†çš„é”™è¯¯æç¤ºå’Œä¿®å¤æ­¥éª¤
  - æµç¨‹ä¼šåœ¨ `verify:config` é˜¶æ®µç»ˆæ­¢

### è¯´æ˜

- `ci:check` ä¼šè‡ªåŠ¨ä½¿ç”¨ `SKILL_MODE=steps_and_cards` æ¨¡å¼ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®
- æ‰€æœ‰ä»£ç æ”¹åŠ¨å·²åŒ…å«åœ¨ä»“åº“ä¸­ï¼Œæœ¬åœ°æ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç æ–‡ä»¶
- åªéœ€ç¡®ä¿ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®å³å¯

## æœ¬åœ°è¿è¡Œ ci:check çš„æœ€å°å‡†å¤‡ï¼ˆè¯¦ç»†ç‰ˆï¼‰

### 1. å®‰è£…ä¾èµ–

```bash
npm i
```

### 2. è®¾ç½® DEEPSEEK_API_KEY

æŒ‰ç…§ä¸Šé¢çš„"æœ¬åœ°ç¯å¢ƒè®¾ç½®"æ­¥éª¤é…ç½®ï¼Œåˆ›å»º `.env.local` æ–‡ä»¶å¹¶æ·»åŠ  `DEEPSEEK_API_KEY`ã€‚

### 3. å¯é€‰ï¼šæœ¬åœ°ä¹Ÿè®¾ç½® SKILL_MODE=steps_and_cards

ä¸ºäº†ä¸ CI è¡Œä¸ºä¸€è‡´ï¼Œå¯ä»¥åœ¨ `.env.local` ä¸­æ·»åŠ  `SKILL_MODE=steps_and_cards`ï¼ˆä½†æ³¨æ„ `ci:check` ä¼šå¼ºåˆ¶ä½¿ç”¨æ­¤æ¨¡å¼ï¼‰ã€‚

### 4. æ¨èï¼šå¹²å‡€å·¥ä½œåŒº

ä¸ºäº†ç¡®ä¿æµ‹è¯•ç»“æœçš„å¯é‡å¤æ€§ï¼Œå»ºè®®åœ¨è¿è¡Œ `ci:check` å‰ç¡®ä¿å·¥ä½œåŒºå¹²å‡€ï¼š

```bash
# æ£€æŸ¥å·¥ä½œåŒºçŠ¶æ€
git status

# å¦‚æœéœ€è¦ï¼Œæ¸…ç†æœªè·Ÿè¸ªçš„æ–‡ä»¶ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
git clean -fd
```

### 5. è¿è¡Œ CI æ£€æŸ¥

```bash
# ä½¿ç”¨é»˜è®¤çš„ steps_and_cards æ¨¡å¼ï¼ˆæ¨èï¼Œci:check ä¼šå¼ºåˆ¶ä½¿ç”¨æ­¤æ¨¡å¼ï¼‰
npm run ci:check
```

## åœ¨ Cursor ç¯å¢ƒä¸­å¯¹é½é…ç½®

### 1. æ£€æŸ¥å½“å‰é…ç½®

```bash
npm run verify:config
```

### 2. åˆ›å»ºæœŸæœ›é…ç½®æ–‡ä»¶

å¦‚æœå‘ç°é…ç½®å·®å¼‚ï¼Œå¯ä»¥åˆ›å»º `smoke.config.json` æ–‡ä»¶æ¥è®°å½•æœŸæœ›çš„é…ç½®å€¼ã€‚

### 3. ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼

åœ¨ CI/CD æµç¨‹ä¸­ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼ï¼Œç¡®ä¿é…ç½®ä¸€è‡´æ€§ï¼š

```bash
SMOKE_STRICT_CONFIG=1 npm run verify:config
```

### 4. è¿è¡Œå®Œæ•´ CI æ£€æŸ¥

```bash
npm run ci:check
```

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆæˆ‘çš„æœ¬åœ°æµ‹è¯•é€šè¿‡äº†ï¼Œä½† CI å¤±è´¥äº†ï¼Ÿ

A: å¯èƒ½æ˜¯é…ç½®å·®å¼‚å¯¼è‡´çš„ã€‚è¿è¡Œ `npm run verify:config` æ£€æŸ¥é…ç½®å·®å¼‚ï¼Œç‰¹åˆ«æ˜¯ï¼š
- Node/npm ç‰ˆæœ¬
- ç¯å¢ƒå˜é‡è®¾ç½®
- LLM API é…ç½®

### Q: å¦‚ä½•ç¡®ä¿ Cursor ç¯å¢ƒå’Œæœ¬åœ°ç¯å¢ƒé…ç½®ä¸€è‡´ï¼Ÿ

A: 
1. åˆ›å»º `smoke.config.json` æ–‡ä»¶è®°å½•æœŸæœ›é…ç½®
2. åœ¨ Cursor å’Œæœ¬åœ°éƒ½è¿è¡Œ `SMOKE_STRICT_CONFIG=1 npm run verify:config` ç¡®ä¿é…ç½®ä¸€è‡´
3. ä½¿ç”¨ç›¸åŒçš„ Node/npm ç‰ˆæœ¬

### Q: é…ç½®æ ¡éªŒå¤±è´¥æ€ä¹ˆåŠï¼Ÿ

A: 
- å¦‚æœæ˜¯è­¦å‘Šï¼ˆwarn æ¨¡å¼ï¼‰ï¼Œå¯ä»¥ç»§ç»­è¿è¡Œæµ‹è¯•ï¼Œä½†å»ºè®®ä¿®å¤é…ç½®å·®å¼‚
- å¦‚æœæ˜¯é”™è¯¯ï¼ˆå¦‚ API Key æœªè®¾ç½®ï¼‰ï¼Œå¿…é¡»ä¿®å¤åæ‰èƒ½è¿è¡Œæµ‹è¯•
  - æŸ¥çœ‹é”™è¯¯è¾“å‡ºä¸­çš„"å¦‚ä½•ä¿®å¤"æç¤º
  - æŒ‰ç…§æç¤ºåœ¨æœ¬åœ°æˆ– CI ç¯å¢ƒä¸­è®¾ç½®ç›¸åº”çš„ç¯å¢ƒå˜é‡
- åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œä»»ä½•å·®å¼‚éƒ½ä¼šå¯¼è‡´å¤±è´¥

### Q: ä¸ºä»€ä¹ˆ ci:check é»˜è®¤ä½¿ç”¨ steps_and_cards æ¨¡å¼ï¼Ÿ

A: 
- ç¡®ä¿ Skill ç³»ç»Ÿçš„å•ä¸€æ•°æ®æºåŸåˆ™ï¼ˆnextSteps å’Œ actionCards å®Œå…¨ç”± Skill ç³»ç»Ÿç”Ÿæˆï¼‰
- éªŒè¯ LLM è¾“å‡ºå‰¥ç¦»é€»è¾‘çš„æ­£ç¡®æ€§
- éªŒè¯ gate/contract ä¸€è‡´æ€§
- æå‡è¾“å‡ºä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§

### Q: æœ¬åœ°å¼€å‘æ—¶å¦‚ä½•æµ‹è¯•ä¸åŒçš„ SKILL_MODEï¼Ÿ

A: 
```bash
# æµ‹è¯• off æ¨¡å¼
SKILL_MODE=off npm run smoke

# æµ‹è¯• cards_only æ¨¡å¼
SKILL_MODE=cards_only npm run smoke

# æµ‹è¯• steps_and_cards æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
SKILL_MODE=steps_and_cards npm run smoke
# æˆ–ç›´æ¥
npm run ci:check
```

## Question Policy å›å½’ç”¨ä¾‹æµ‹è¯•

`test:question:policy` ä¸“é—¨è¦†ç›–è‹æ ¼æ‹‰åº•å¼æé—®ç­–ç•¥ï¼ˆSocratic Questioning Policyï¼‰çš„å›å½’ç”¨ä¾‹ï¼Œç¡®ä¿æé—®ä¼˜åŒ–ç­–ç•¥æ­£ç¡®å·¥ä½œã€‚

### ç›®çš„

1. **éªŒè¯ç¦ç”¨æ¡ä»¶**ï¼šç¡®ä¿ support/crisis è·¯ç”±å’Œ emotion>=9/riskLevel>=urgent åœºæ™¯ä¸è¾“å‡ºè‹æ ¼æ‹‰åº•æŒ‘æˆ˜
   - support è·¯ç”±ï¼šç”¨æˆ·æ˜ç¡®åªæƒ³å€¾è¯‰ï¼Œä¸åº”è¿›è¡Œè®¤çŸ¥æŒ‘æˆ˜
   - crisis è·¯ç”±ï¼šå±æœºåœºæ™¯ä¼˜å…ˆç¨³å®šåŒ–/å®‰å…¨é—®é¢˜
   - é«˜æƒ…ç»ªå¼ºåº¦ï¼ˆemotion>=9ï¼‰ï¼šä¼˜å…ˆç¨³å®šåŒ–ï¼Œä¸åšè®¤çŸ¥æŒ‘æˆ˜
   - é«˜é£é™©ç­‰çº§ï¼ˆriskLevel>=frequent/planï¼‰ï¼šä¼˜å…ˆå®‰å…¨é—®é¢˜

2. **éªŒè¯æé—®è´¨é‡**ï¼š
   - intake é˜¶æ®µï¼šé—®é¢˜æ€»æ•°<=2ï¼ŒåŒ…å«å¯é€‰é¡¹æˆ–0-10æ‰“åˆ†çš„æ¯”ä¾‹>=50%
   - gap_followup é˜¶æ®µï¼šè¿”å›å•é—®æ ¼å¼ï¼Œä¼˜å…ˆä½¿ç”¨é€‰é¡¹æˆ–0-10æ‰“åˆ†

3. **è¦†ç›–å…¸å‹åœºæ™¯**ï¼šæµ‹è¯•èŒåœºå‹åŠ›ã€å®¶åº­å†²çªã€åå¤æ‹…å¿ƒã€å¤±çœ ã€æ‹–å»¶è‡ªè´£ç­‰å¸¸è§åœºæ™¯

### æœ¬åœ°è¿è¡Œ

```bash
npm run test:question:policy
```

### CI é›†æˆ

`test:question:policy` å·²é›†æˆåˆ° `ci:check` æµç¨‹ä¸­ï¼Œåœ¨ `validate:skills` ä¹‹åã€`test:contract` ä¹‹å‰æ‰§è¡Œã€‚

**å¤±è´¥æ„å‘³ç€**ï¼š
- Question Policy çš„ç¦ç”¨æ¡ä»¶å¯èƒ½è¢«æ”¹åï¼ˆå¦‚ support/crisis è·¯ç”±è¾“å‡ºäº†è‹æ ¼æ‹‰åº•æŒ‘æˆ˜ï¼‰
- æé—®è´¨é‡ä¸ç¬¦åˆè¦æ±‚ï¼ˆå¦‚é—®é¢˜æ•°é‡è¶…é™ã€ç¼ºå°‘å¯é€‰é¡¹/0-10æ‰“åˆ†ï¼‰
- ç­–ç•¥å®ç°é€»è¾‘é”™è¯¯ï¼ˆå¦‚ intake/gap_followup é˜¶æ®µé—®é¢˜æ ¼å¼ä¸æ­£ç¡®ï¼‰

### æµ‹è¯•è¦†ç›–

æµ‹è¯•è„šæœ¬è¦†ç›–ä»¥ä¸‹åœºæ™¯ï¼š

1. **intake é˜¶æ®µæµ‹è¯•**ï¼ˆ9ä¸ªç”¨ä¾‹ï¼‰ï¼š
   - èŒåœºå‹åŠ›ã€å®¶åº­å†²çªã€åå¤æ‹…å¿ƒã€å¤±çœ ã€æ‹–å»¶è‡ªè´£åœºæ™¯
   - support/crisis è·¯ç”±ç¦ç”¨éªŒè¯
   - emotion>=9 ç¦ç”¨éªŒè¯
   - å¯é€‰é¡¹/0-10æ‰“åˆ†æ¯”ä¾‹ç»Ÿè®¡

2. **gap_followup é˜¶æ®µæµ‹è¯•**ï¼ˆ8ä¸ªç”¨ä¾‹ï¼‰ï¼š
   - context/duration/impact/risk ç¼ºå¤±åœºæ™¯
   - support/crisis è·¯ç”±ç¦ç”¨éªŒè¯
   - riskLevel frequent/plan ç¦ç”¨éªŒè¯
   - å•é—®æ ¼å¼å’Œå¯é€‰é¡¹/0-10æ‰“åˆ†éªŒè¯

## Contract è¾¹ç•Œç”¨ä¾‹æµ‹è¯•

`test:contract:edge` ä¸“é—¨è¦†ç›– Contract éªŒè¯çš„è¾¹ç•Œåœºæ™¯ï¼Œç¡®ä¿è§„åˆ™æ­£ç¡®æ€§ï¼š

### ç›®çš„

1. **é˜²æ­¢å†å² bug å›å½’**ï¼šä¸“é—¨æµ‹è¯•"å®Œæˆæ ‡å‡†(rightPart)æ•°å­—è¯¯åˆ¤ä¸º metric"çš„å†å²å‘
   - ç¡®ä¿å®Œæˆæ ‡å‡†ä¸­çš„æ•°å­—ï¼ˆå¦‚"è‡³å°‘5æ¬¡"ï¼‰ä¸ä¼šè¢«è¯¯åˆ¤ä¸ºä¸»å¥éƒ¨åˆ†çš„æ—¶é•¿/æ¬¡æ•°
   - éªŒè¯ leftPart/rightPart æ‹†åˆ†é€»è¾‘çš„æ­£ç¡®æ€§

2. **éªŒè¯æ–°å¢ metric è§„åˆ™**ï¼šæµ‹è¯•æ–°å¢çš„ metric è¯†åˆ«è§„åˆ™
   - `\d+æ¬¡` è¡¨è¾¾ï¼ˆå¦‚"åš3æ¬¡""ç»ƒä¹ 2æ¬¡"ï¼‰
   - `æ¯æ¬¡\d+åˆ†é’Ÿ/å°æ—¶` è¡¨è¾¾ï¼ˆå¦‚"æ¯æ¬¡3åˆ†é’Ÿ""æ¯æ¬¡10åˆ†é’Ÿ"ï¼‰

3. **è¾¹ç•Œåœºæ™¯è¦†ç›–**ï¼šæµ‹è¯•å„ç§è¾¹ç•Œæƒ…å†µ
   - è‹±æ–‡åˆ†å·å†’å·çš„å®Œæˆæ ‡å‡†æ ¼å¼
   - å¤šç§ metric è¡¨è¾¾ç»„åˆ
   - å®Œæˆæ ‡å‡†æœ‰æ•°å­—ä½†ä¸»å¥ä¹Ÿæœ‰ metric çš„æƒ…å†µ

### æœ¬åœ°è¿è¡Œ

```bash
npm run test:contract:edge
```

### CI é›†æˆ

`test:contract:edge` å·²é›†æˆåˆ° `ci:check` æµç¨‹ä¸­ï¼Œåœ¨ `test:contract` ä¹‹åã€`test:strip` ä¹‹å‰æ‰§è¡Œã€‚

**å¤±è´¥æ„å‘³ç€**ï¼š
- Contract è§„åˆ™å¯èƒ½è¢«æ”¹åï¼ˆå¦‚ leftPart/rightPart æ‹†åˆ†é€»è¾‘å‡ºé”™ï¼‰
- Prompt äº§å‡ºæ ¼å¼æ¼‚ç§»ï¼ˆå¦‚å®Œæˆæ ‡å‡†æ ¼å¼å˜åŒ–å¯¼è‡´æ‹†åˆ†å¤±è´¥ï¼‰
- æ–°å¢çš„ metric è§„åˆ™æœªæ­£ç¡®å®ç°

### éªŒæ”¶æŠ¥å‘Š

`test:contract:edge` çš„é›†æˆéªŒæ”¶æŠ¥å‘Šå·²å½’æ¡£ï¼ŒåŒ…å«å®Œæ•´çš„æµ‹è¯•ç»“æœå’Œ CI è¯æ˜ï¼š

- ğŸ“„ [2025-12-14 Contract Edge CI Acceptance Report](../acceptance/2025-12-14-contract-edge-ci-acceptance.md)
  - åŒ…å« `test:contract:edge` 10/10 æµ‹è¯•é€šè¿‡ç»“æœ
  - åŒ…å« `ci:check` å…¨é“¾è·¯é€šè¿‡çš„å…³é”®è¾“å‡ºç‰‡æ®µ
  - ä½œä¸ºå¯è¿½æº¯çš„éªŒæ”¶è¯æ®ï¼ˆå« Git Hashã€å·¥ä½œåŒºçŠ¶æ€ç­‰å…ƒä¿¡æ¯ï¼‰

## ç›¸å…³å‘½ä»¤

- `npm run verify:config` - é…ç½®æ ¡éªŒï¼ˆwarn æ¨¡å¼ï¼‰
- `SMOKE_STRICT_CONFIG=1 npm run verify:config` - é…ç½®æ ¡éªŒï¼ˆstrict æ¨¡å¼ï¼‰
- `npm run ci:check` - å®Œæ•´ CI æ£€æŸ¥ï¼ˆè‡ªåŠ¨è®¾ç½® `SKILL_MODE=steps_and_cards`ï¼ŒåŒ…å«æ‰€æœ‰éªŒè¯æ­¥éª¤ï¼‰
- `npm run typecheck` - TypeScript ç±»å‹æ£€æŸ¥
- `npm run validate:skills` - Skill å®šä¹‰éªŒè¯
- `npm run test:question:policy` - Question Policy å›å½’ç”¨ä¾‹
- `npm run test:contract` - Contract å›å½’ç”¨ä¾‹
- `npm run test:contract:edge` - Contract è¾¹ç•Œç”¨ä¾‹æµ‹è¯•
- `npm run test:strip` - Conclusion è¾“å‡ºå‰¥ç¦»å›å½’ç”¨ä¾‹
- `npm run smoke` - å†’çƒŸæµ‹è¯•

## .env.local ç¤ºä¾‹

åˆ›å»º `.env.local` æ–‡ä»¶ï¼ˆä¸è¦æäº¤åˆ° Gitï¼‰ï¼š

```bash
# DeepSeek API Keyï¼ˆå¿…é¡»ï¼‰
DEEPSEEK_API_KEY=your_api_key_here

# Skill æ¨¡å¼ï¼ˆæ¨èä½¿ç”¨ steps_and_cardsï¼‰
SKILL_MODE=steps_and_cards

# å¯é€‰ï¼šè°ƒè¯•æ¨¡å¼
# DEBUG_PROMPTS=1

# å¯é€‰ï¼šé—¨ç¦ä¿®å¤ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
# GATE_FIX=1

# å¯é€‰ï¼šç»“è®ºåŒ…å«å†å²ï¼ˆé»˜è®¤ä¸åŒ…å«ï¼‰
# CONCLUSION_INCLUDE_HISTORY=1

# å¯é€‰ï¼šæ€§èƒ½é˜ˆå€¼ï¼ˆé»˜è®¤ 9500msï¼‰
# SMOKE_CONCLUSION_P50_MS=9500
```

**æ³¨æ„**ï¼š`.env.local` æ–‡ä»¶åº”æ·»åŠ åˆ° `.gitignore` ä¸­ï¼Œä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿã€‚
