# 心理疗愈产品 MVP - 前端聊天页面 PRD

## 一、背景与目标

### 1.1 产品定位
面向小红书 20-40 岁职场人群的心理疗愈产品 MVP，提供：
- **诊断（初筛/评估）**：快速理解用户压力来源（职场/家庭/关系）
- **CBT 干预**：认知行为疗法引导
- **轻量可执行行动推荐**：核心亮点=行动推荐“轻量、可做、可完成”

### 1.2 目标用户
- **年龄**：20-40 岁
- **平台**：小红书用户
- **痛点**：职场压力、家庭关系、人际关系困扰
- **需求**：快速被理解，获得可执行动作

### 1.3 MVP 范围
**仅实现 1 个页面**：单对话页面 + 结构化卡片展示

## 二、用户画像

### 2.1 典型用户
- **小A（28岁，产品经理）**：工作压力大，经常失眠，希望快速获得缓解方法
- **小B（35岁，全职妈妈）**：家庭关系紧张，情绪低落，需要倾诉和理解
- **小C（22岁，应届生）**：职场适应困难，焦虑不安，需要具体行动指导

### 2.2 用户旅程
1. **进入页面** → 看到简洁的聊天界面
2. **输入困扰** → 快速获得理解与回应
3. **回答问题** → 完成评估流程（intake → gap_followup → conclusion）
4. **查看结论** → 获得结构化总结 + 行动卡片
5. **执行行动** → 勾选完成清单，展开卡片练习

## 三、核心路径

### 3.1 评估路径（assessment）
```
用户输入初始消息
  ↓
[intake] 系统生成 1-2 个评估问题
  ↓
用户回答
  ↓
[gap_followup] 如有缺口，系统追问 1-2 个澄清问题
  ↓
用户补充回答
  ↓
[conclusion] 系统输出结构化结论：
  - 初筛总结
  - 风险与分流
  - 下一步行动清单（2-3条）
  - 行动卡片（2张）
```

### 3.2 支持路径（support）
```
用户输入（明确表示“只想倾诉”）
  ↓
系统提供共情倾听，不提供建议
```

### 3.3 危机路径（crisis）
```
用户输入包含高风险表达
  ↓
系统立即升级为 crisis 路由
  ↓
显示红色 Banner + 强提醒 + 求助建议
```

## 四、页面信息架构

### 4.1 页面布局
```
┌─────────────────────────────────┐
│  顶部栏：产品名 + 免责声明入口    │
├─────────────────────────────────┤
│                                  │
│      消息流（用户/助手气泡）      │
│                                  │
│  [conclusion 阶段显示结构化区块]  │
│  - 初筛总结                      │
│  - 风险与分流                    │
│  - 下一步行动清单（可勾选）       │
│  - 行动卡片（2张，可展开）        │
│                                  │
├─────────────────────────────────┤
│  输入框 + 发送按钮                │
│  [移动端：键盘弹出不遮挡]          │
└─────────────────────────────────┘
```

### 4.2 组件清单

#### 4.2.1 核心组件
- **ChatShell**：主容器，管理整体布局和状态
- **MessageList**：消息列表容器，自动滚动
- **MessageBubble**：消息气泡（用户/助手）
- **ChatInput**：输入框组件（支持 Enter 发送、Shift+Enter 换行）

#### 4.2.2 结构化渲染组件
- **ConclusionSections**：结论区块容器
  - **SummarySection**：初筛总结区块
  - **RiskTriageSection**：风险与分流区块（crisis 时显示红色 Banner）
  - **NextStepsChecklist**：下一步行动清单（2-3条，可勾选，localStorage 持久化）
  - **ActionCardGrid**：行动卡片网格（2张卡片）
    - **ActionCardItem**：单张卡片
      - 卡片折叠态：标题 + 适用场景 + 预计时长/次数 + "开始/展开"按钮
      - 卡片展开态：steps 列表（每步 ≤16 汉字）+ "开始练习"按钮

#### 4.2.3 辅助组件
- **DebugDrawer**：Debug 面板（可折叠，默认隐藏，显示 debugPrompts 和解析失败原因）
- **DisclaimerModal**：免责声明弹窗

## 五、关键交互

### 5.1 输入交互
- **Enter**：发送消息
- **Shift+Enter**：换行
- **移动端**：键盘弹出时，输入框固定在底部（使用 safe-area-inset-bottom）

### 5.2 消息渲染
- **普通消息**：markdown 渲染（使用 react-markdown）
- **conclusion 阶段**：结构化区块渲染
  - 解析 `reply` 文本，提取【初筛总结】、【风险与分流】、【下一步清单】
  - 渲染 `actionCards` 数组

### 5.3 分阶段体验

#### 5.3.1 intake 阶段
- **UI 提示**：突出显示评估问题（例如使用不同背景色或图标）
- **引导语**："为了更好地了解你的情况，请回答以下问题："

#### 5.3.2 gap_followup 阶段
- **UI 提示**：明确标注澄清问题（例如"我需要你补充：xxx"）
- **视觉区分**：使用不同样式突出显示

#### 5.3.3 conclusion 阶段
- **结构化渲染**：触发所有结构化区块展示
- **降级策略**：如果 zod 校验失败，隐藏结构化区块，仅显示纯文本，并在 Debug 面板显示失败原因

### 5.4 行动卡片交互
- **折叠态**：
  - 显示：标题、适用场景（when）、预计时长/次数（effort）、"开始/展开"按钮
- **展开态**：
  - 显示：steps 列表（每步 ≤16 汉字，分步展示）
  - "开始练习"按钮：点击后以更大字号/分步方式呈现 steps（MVP 不做计时器）

### 5.5 下一步清单交互
- **可勾选**：每条清单项可勾选"我完成了"
- **持久化**：勾选状态保存在 localStorage（key: `nextStepsCompleted_${messageId}`）
- **视觉反馈**：已勾选项显示删除线或灰色

### 5.6 Crisis 路由特殊处理
- **红色 Banner**：在 RiskTriageSection 顶部显示醒目的红色警告 Banner
- **强提醒文本**："检测到高风险表达，建议立即寻求专业帮助"
- **求助建议区块**：显示求助热线、资源链接等

## 六、异常与降级

### 6.1 结构化解析失败
- **场景**：后端返回的 `actionCards` 或 `nextStepsLines` 无法通过 zod 校验
- **降级策略**：
  1. 隐藏结构化区块（NextStepsChecklist、ActionCardGrid）
  2. 将 `reply` 作为纯文本/markdown 渲染
  3. 在 Debug 面板显示"结构化解析失败原因"（如果 DEBUG_PROMPTS 开启）

### 6.2 网络错误
- **场景**：API 请求失败
- **处理**：显示错误提示，允许重试

### 6.3 数据缺失
- **场景**：`actionCards` 为空或 `nextStepsLines` 为空
- **处理**：仅显示已有的结构化区块，缺失部分不显示

## 七、技术实现

### 7.1 技术栈
- **框架**：Next.js 14（App Router）+ TypeScript
- **样式**：TailwindCSS + shadcn/ui（按钮/卡片/抽屉/alert）
- **状态管理**：Zustand（或 useReducer）管理会话状态
- **Markdown 渲染**：react-markdown
- **Schema 校验**：zod（响应 schema 校验）

### 7.2 状态管理
```typescript
interface ChatState {
  messages: Message[];
  currentState: ChatState; // 'normal' | 'awaiting_followup'
  routeType: RouteType; // 'crisis' | 'assessment' | 'support'
  assessmentStage: AssessmentStage; // 'intake' | 'gap_followup' | 'conclusion'
  initialMessage?: string; // 用于多轮对话推进
  isLoading: boolean;
  error: string | null;
}
```

### 7.3 API Client
- **文件**：`lib/api/chat.ts`
- **功能**：
  - 发送消息请求
  - 携带 `state`、`assessmentStage`、`meta.initialMessage`（确保多轮对话可推进）
  - 响应解析与 zod 校验

### 7.4 响应 Schema 校验
```typescript
// 使用 zod 校验 ChatResponse
const ChatResponseSchema = z.object({
  reply: z.string(),
  routeType: z.enum(['crisis', 'assessment', 'support']),
  state: z.enum(['normal', 'awaiting_followup']).optional(),
  assessmentStage: z.enum(['intake', 'gap_followup', 'conclusion']).optional(),
  actionCards: z.array(ActionCardSchema).optional(),
  // ... 其他字段
});
```

## 八、验收标准

### 8.1 功能验收

#### 8.1.1 基础对话
- [ ] 用户可以输入消息并发送
- [ ] 支持 Enter 发送、Shift+Enter 换行
- [ ] 移动端键盘弹出不遮挡输入栏
- [ ] 消息流自动滚动到底部

#### 8.1.2 评估路径（assessment）
- [ ] **intake 阶段**：系统生成 1-2 个评估问题，UI 突出显示
- [ ] **gap_followup 阶段**：系统追问 1-2 个澄清问题，UI 明确标注
- [ ] **conclusion 阶段**：正确解析并渲染结构化区块
  - [ ] 初筛总结区块显示
  - [ ] 风险与分流区块显示
  - [ ] 下一步行动清单显示（2-3条，可勾选）
  - [ ] 行动卡片显示（2张，可展开）

#### 8.1.3 支持路径（support）
- [ ] 用户输入"只想倾诉"等关键词，系统路由为 support
- [ ] 系统提供共情倾听，不显示结构化区块

#### 8.1.4 危机路径（crisis）
- [ ] 用户输入高风险表达，系统路由为 crisis
- [ ] 显示红色 Banner + 强提醒
- [ ] 显示求助建议区块

#### 8.1.5 行动卡片
- [ ] 卡片折叠态：显示标题、适用场景、预计时长/次数、"开始/展开"按钮
- [ ] 卡片展开态：显示 steps 列表（每步 ≤16 汉字）
- [ ] "开始练习"按钮：点击后以更大字号/分步方式呈现 steps

#### 8.1.6 下一步清单
- [ ] 清单项可勾选"我完成了"
- [ ] 勾选状态保存在 localStorage
- [ ] 已勾选项显示视觉反馈（删除线或灰色）

#### 8.1.7 Debug 面板
- [ ] 默认隐藏
- [ ] 可折叠展开
- [ ] 显示 `debugPrompts`（如果 DEBUG_PROMPTS 开启）
- [ ] 显示结构化解析失败原因（如果校验失败）

### 8.2 数据验收

#### 8.2.1 请求数据
- [ ] 请求携带 `message`、`history`、`state`、`assessmentStage`、`meta.initialMessage`
- [ ] 多轮对话时，`state` 和 `assessmentStage` 正确传递

#### 8.2.2 响应数据
- [ ] 正确解析 `routeType`、`state`、`assessmentStage`
- [ ] 正确解析 `actionCards`（使用 zod 校验）
- [ ] 正确解析 `reply` 文本中的【下一步清单】（从文本中提取）

#### 8.2.3 降级策略
- [ ] zod 校验失败时，隐藏结构化区块，仅显示纯文本
- [ ] Debug 面板显示失败原因

### 8.3 UI/UX 验收

#### 8.3.1 视觉风格
- [ ] 参考"壹心理"：专业但不冷冰、倾诉入口显眼
- [ ] 参考"小睡眠/冥想类"：轻量练习卡片、步骤清晰
- [ ] UI 调性：克制、温和、偏"生活方式产品"，避免医院感
- [ ] Crisis 路由：严肃醒目（红色 Banner）

#### 8.3.2 响应式
- [ ] 移动端适配（max-w、safe-area）
- [ ] 输入栏 sticky 定位（移动端键盘弹出不遮挡）

#### 8.3.3 交互反馈
- [ ] 加载状态显示
- [ ] 错误提示显示
- [ ] 勾选/展开等操作有视觉反馈

### 8.4 性能验收
- [ ] 页面加载时间 < 2s
- [ ] 消息发送响应时间 < 3s（依赖后端）
- [ ] 滚动流畅（60fps）

## 九、本地验证步骤

### 9.1 评估路径验证
1. 启动开发服务器：`npm run dev`
2. 打开浏览器访问 `http://localhost:3000`
3. **intake 阶段**：
   - 输入："最近工作压力很大，经常失眠"
   - 验证：系统返回 1-2 个评估问题，UI 突出显示
4. **gap_followup 阶段**：
   - 回答评估问题（例如："持续了2周，影响睡眠和工作"）
   - 验证：如有缺口，系统追问澄清问题，UI 明确标注
5. **conclusion 阶段**：
   - 补充回答后，系统进入 conclusion
   - 验证：显示结构化区块（初筛总结、风险与分流、下一步清单、行动卡片）

### 9.2 Crisis 路由验证
1. 输入高风险表达："我想死" 或 "伤害自己的想法：经常出现"
2. 验证：系统路由为 crisis，显示红色 Banner + 强提醒 + 求助建议

### 9.3 降级策略验证
1. 模拟 zod 校验失败（修改 API 返回的 `actionCards` 格式）
2. 验证：隐藏结构化区块，仅显示纯文本，Debug 面板显示失败原因

### 9.4 行动卡片验证
1. 进入 conclusion 阶段
2. 验证：显示 2 张行动卡片
3. 点击"开始/展开"按钮
4. 验证：展开显示 steps 列表
5. 点击"开始练习"按钮
6. 验证：以更大字号/分步方式呈现 steps

### 9.5 下一步清单验证
1. 进入 conclusion 阶段
2. 验证：显示 2-3 条下一步清单
3. 勾选其中一条
4. 刷新页面
5. 验证：勾选状态已保存（localStorage）

## 十、后续迭代方向

### 10.1 短期优化
- [ ] 添加流式响应（Streaming）
- [ ] 优化移动端体验
- [ ] 添加更多动画效果

### 10.2 中期扩展
- [ ] 添加用户认证
- [ ] 接入数据库（持久化对话历史）
- [ ] 情绪趋势分析可视化

### 10.3 长期规划
- [ ] 多模态输入（语音、图片）
- [ ] 个性化推荐
- [ ] 专业咨询师转介

---

**文档版本**：v1.0  
**创建日期**：2025-01-XX  
**最后更新**：2025-01-XX
